<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Dra. Aisha</title>
    <link rel="icon" type="image/x-icon" href="img/icone-dr-aisha.ico">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f4f6f8; } /* Fundo levemente cinza para o painel */
        
        .dashboard-container {
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .titulo-secao {
            color: #555;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
            margin-bottom: 20px;
        }

        .dashboard-grid {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        /* CARD DO GR√ÅFICO */
        .card-grafico {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            flex: 1;
            min-width: 320px;
            max-width: 450px;
            display: flex;
            flex-direction: column;
        }

        .header-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-card h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #333;
        }

        .total-badge {
            font-size: 0.9rem;
            color: #888;
            font-weight: 400;
        }

        /* √ÅREA DA LISTA DE PACIENTES */
        .area-lista {
            flex: 2;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            min-width: 300px;
        }

        /* Bot√£o Sair */
        #btn-logout {
            background-color: #ff6b6b;
            border: none;
            padding: 8px 20px;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <header class="novo-header">
        <div class="header-container" style="justify-content: space-between;">
            <a href="#" class="logo">
                <img src="img/layout.png" alt="Logo" style="height: 40px;">
            </a>
            <div style="display: flex; gap: 15px; align-items: center;">
                <span style="color: #2ADCA1; font-weight: bold;">Painel Administrativo</span>
                <button id="btn-logout">Sair</button>
            </div>
        </div>
    </header>

    <main class="dashboard-container">
        
        <h2 class="titulo-secao">Geral</h2>

        <div class="dashboard-grid">
            
            <div class="card-grafico">
                <div class="header-card">
                    <h3>Pacientes</h3>
                    <span class="total-badge" id="texto-total">Carregando...</span>
                </div>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="graficoIdades"></canvas>
                </div>
            </div>

            <div class="area-lista">
                <div class="header-card">
                    <h3>A√ß√µes R√°pidas</h3>
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button onclick="window.location.href='admin-lista.html'" class="btn-agendar" style="flex: 1;">
                        üìÇ Ver Lista Completa de Pacientes
                    </button>
                    </div>
                
                <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                
                <p style="color: #777; font-size: 0.9rem;">
                    Utilize o bot√£o acima para acessar a lista detalhada, editar prontu√°rios e gerenciar cadastros.
                </p>
            </div>

        </div>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('authToken');
            const role = localStorage.getItem('userRole');
            
            // Prote√ß√£o de Rota
            if (!token || role !== 'admin') {
                localStorage.clear();
                window.location.href = 'login.html';
                return;
            }

            // Logout
            document.getElementById('btn-logout').addEventListener('click', () => {
                localStorage.clear();
                window.location.href = 'login.html';
            });

            // CARREGAR DADOS DO GR√ÅFICO
            try {
                const response = await fetch('https://aishageriatria.onrender.com/api/admin/stats/idades', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Falha ao carregar dados');
                
                const data = await response.json();

                // Atualizar Texto Total
                document.getElementById('texto-total').innerText = `Total geral: ${data.total}`;

                // Configurar Gr√°fico Chart.js
                const ctx = document.getElementById('graficoIdades').getContext('2d');
                
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: [
                            'At√© 50', 
                            '51 at√© 60', 
                            '61 at√© 70', 
                            '71 at√© 80', 
                            '81 at√© 90', 
                            'Maior que 90', 
                            'N√£o informado'
                        ],
                        datasets: [{
                            data: [
                                data.grupos.Ate50,
                                data.grupos.De51a60,
                                data.grupos.De61a70,
                                data.grupos.De71a80,
                                data.grupos.De81a90,
                                data.grupos.Maior90,
                                data.grupos.NaoInformado
                            ],
                            backgroundColor: [
                                '#B0BEC5', // Cinza (At√© 50)
                                '#90CAF9', // Azul Claro (51-60)
                                '#9575CD', // Roxo Suave (61-70)
                                '#00E676', // Verde Neon (71-80) -> DESTAQUE
                                '#FF8A65', // Laranja Suave (81-90)
                                '#607D8B', // Azul Acinzentado (>90)
                                '#E1BEE7'  // Lil√°s (N/I)
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff',
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20,
                                    font: { family: "'Montserrat', sans-serif", size: 12 },
                                    color: '#555'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                padding: 12,
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) { label += ': '; }
                                        let value = context.raw;
                                        let percentage = ((value / data.total) * 100).toFixed(1) + '%';
                                        return `${label} ${value} (${percentage})`;
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error("Erro:", error);
                document.getElementById('texto-total').innerText = "Erro ao carregar.";
            }
        });
    </script>
</body>
</html>